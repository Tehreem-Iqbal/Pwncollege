#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include "reg.h"
#include "stack.h"
#include "flow.h"
#include "mem.h"



unsigned char vmcode[1024] = {0xc6,0x40,0x1,0x1,0x8,0x8,0x40,0x8,0x0,0x1,0x8,0x0,0x10,0x8,0x0,0x30,0x40,0x40,0xfe,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x31,0x40,0x40,0x9b,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x32,0x40,0x40,0x3c,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x33,0x40,0x40,0xcc,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x34,0x40,0x40,0xe3,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x35,0x40,0x40,0xb0,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x36,0x40,0x40,0x1e,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x37,0x40,0x40,0xe6,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x38,0x40,0x40,0x88,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x39,0x40,0x40,0x12,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x3a,0x40,0x40,0xa1,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x3b,0x40,0x40,0xd3,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x3c,0x40,0x40,0xc3,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x3d,0x40,0x40,0x2,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x3e,0x40,0x40,0xb2,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x3f,0x40,0x40,0xdf,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x40,0x40,0x40,0x95,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x41,0x40,0x40,0xf6,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x42,0x40,0x40,0x98,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x43,0x40,0x40,0x57,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x44,0x40,0x40,0x66,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x45,0x40,0x40,0xc,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x46,0x40,0x40,0x77,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x47,0x40,0x40,0xe5,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x48,0x40,0x40,0x6d,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x49,0x40,0x40,0x42,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x4a,0x40,0x40,0xbf,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x4b,0x40,0x40,0x1c,0x40,0x10,0x40,0x1,0x1,0x10,0x10,0x1,0x1,0x2,0x40,0x0,0x8,0x10,0x0,0x8,0x1,0x0,0x8,0x40,0xd5,0x40,0x8,0x10,0x10,0x40,0x10,0x10,0x1,0xff,0x40,0x2,0x2,0x10,0x40,0x2,0x10,0x1,0x40,0x8,0x0,0x1,0x8,0x0,0x40,0x1,0x40,0x1,0x1,0x1,0x1,0x4,0x40,0x0,0x8,0x1,0x0,0x8,0x40,0xa9,0x40,0x2,0x2,0x20,0x8,0xff,0x40,0x2,0x2,0x10,0x10,0x0,0x40,0x2,0x2,0x4,0x10,0x97,0x40,0x2,0x2,0x20,0x8,0x10,0x8,0x2,0x0,0x8,0x8,0xb8,0x40,0x1,0xa,0x40,0x10,0x1,0x40,0x40,0x2,0x80,0x4,0x1,0x40,0x40,0x0,0x80,0x8,0x9c,0x40,0x1,0x1c,0x40,0x10,0x1,0x40,0x40,0x2,0x80,0x4,0xc7,0x40,0x40,0x0,0x40,0x1,0x2,0x80,0x20,0x0,0x40,0x1,0x4,0x10,0x1,0xff,0x40,0x10,0x0,0x40,0x40,0x2,0x10,0x40,0x2,0x80,0x1,0x0,0x40,0x1,0x4,0x10,0x1,0x0,0x40,0x10,0x2,0x10,0x10,0x1,0x40,0x40,0x2,0x80,0x4,0x0,0x40,0x40,0x0,0x80,0x8,0xc2,0x40,0x1,0x5,0x40,0x10,0x1,0x40,0x40,0x2,0x80,0x4,0x40,0x8,0x0,0x1,0x8,0x0,0x10,0x8,0x0,0x30,0x40,0x1,0x22,0x40,0x10,0x0,0x40,0x40,0x2,0x80,0x1,0x0,0x8,0x10,0x0,0x8,0x1,0x0,0x8,0x40,0x2,0x40,0x8,0x30,0x40,0x40,0x80,0x40,0x1,0x1c,0x40,0x10,0x2,0x40,0x2,0x8,0x10,0x2,0x2,0x8,0x0,0x95,0x40,0x8,0x0,0x40,0x10,0x10,0x4,0x2,0xb1,0x40,0x2,0x2,0x20,0x10,0xab,0x40,0x2,0x2,0x20,0x6,0x0,0x0 };

int interpret_add(unsigned char arg1, unsigned char arg2){
    printf(" ---------------------------------------------------------------------------------------------------------\n");
    printf(" | %-3d |    ADD    | 0x%02hhX  |  0x%02hhX | a= 0x%02hhX | b= 0x%02hhX | c= 0x%02hhX | d= 0x%02hhX | s= 0x%02hhX | i= 0x%02hhX | f= 0x%02hhX |\n",
        registers.i, arg1, arg2,
        registers.a, registers.b, registers.c, registers.d,
        registers.s, registers.i, registers.f);
    //printf("[s] ADD %c %c\n", define_register(arg1), define_register(arg2));
    int sum = (int)describe_register(arg1) + (int)describe_register(arg2);
    set_register(arg1, sum);
}

enum arch_syscall{
    SYSCALL_OPEN = 0x20,
    SYSCALL_WRITE_MEM = 0x4,
    SYSCALL_READ_MEM = 0x1,
    SYSCALL_READ_CODE = 0x10,
    SYSCALL_SLEEP = 0x02,
    SYSCALL_EXIT = 0x08
};

int interpret_sys(unsigned char arg1, unsigned char arg2){
    printf(" ---------------------------------------------------------------------------------------------------------\n");
    printf(" | %-3d |    SYS    | 0x%02hhX  |  0x%02hhX | a= 0x%02hhX | b= 0x%02hhX | c= 0x%02hhX | d= 0x%02hhX | s= 0x%02hhX | i= 0x%02hhX | f= 0x%02hhX |\n",
           registers.i, arg1, arg2,
           registers.a, registers.b, registers.c, registers.d,
           registers.s, registers.i, registers.f);
    int ret;
    switch (arg1)
    {
    case SYSCALL_WRITE_MEM:
        printf("[*] b: %d , %d\n", (int)registers.b,(int)registers.b+768);
        printf("[*] write(%#hhx ,%p, %#hhx)\n", registers.a, &vmcode[(int)registers.b+768], registers.c);
        ret = write(registers.a, &vmcode[(int)registers.b + 768], registers.c);
        printf("%s\n",&vmcode[registers.b] );
        break;
    case SYSCALL_OPEN:
        printf("[*] open(%p ,%#hhx, %#hhx)\n",  &vmcode[registers.a],registers.b ,registers.c);
        ret = open(&vmcode[registers.a + 768], registers.b,  registers.c);
        printf("%s\n",&vmcode[registers.a] );
        break;
    case SYSCALL_READ_CODE:
        printf("[*] read_code(%#hhx ,%p, %#hhx)\n", registers.a, &vmcode[registers.b * 3] , registers.c);
        ret = read(registers.a, &vmcode[registers.b * 3] , registers.c ); // read_code
        printf("%s\n",&vmcode[registers.b * 3] );
        break;
    case SYSCALL_SLEEP:
        printf("[*] sleep(%#hhx)\n", registers.a);
        ret = sleep(registers.a);
        break;
    case SYSCALL_READ_MEM:
        printf("[*] read_memory(%#hhx ,%p, %#hhx)\n", registers.a, &vmcode[registers.b+768] , registers.c);
        ret = read(registers.a, &vmcode[registers.b+768] , registers.c ); //read_memory
        printf("%s\n",&vmcode[registers.b] );
        break;
    case SYSCALL_EXIT:
        printf("[*] exit(%#hhx)\n", registers.a);
        //exit(registers.a);
        break;
    default:
        return -1;
    }
    set_register(arg2, ret);
    return 0;
}

enum arch_inst {
    INST_LDM = 0x1,
    INST_STM = 0x2,
    INST_ADD = 0x10,
    INST_STK = 0x8,
    INST_JMP = 0x20,
    INST_CMP = 0x4,
    INST_IMM = 0x40,
    INST_SYS = 0x80
};
int interpret_instruction(unsigned  char operation, unsigned  char arg1, unsigned  char arg2){

    switch (operation)
    {
    case INST_SYS:
        interpret_sys(arg1, arg2);
        break;
    case INST_STM:
        interpret_stm(arg1, arg2);
        break;
    case INST_IMM:
        interpret_imm(arg1, arg2);
        break;
    case INST_JMP:
        interpret_jmp(arg1, arg2);
        break;
    case INST_CMP:
        interpret_cmp(arg1, arg2);
        break;
    case INST_STK:
        interpret_stk(arg1, arg2);
        break;
    case INST_LDM:
        interpret_ldm(arg1, arg2);
        break;
    case INST_ADD:
        interpret_add(arg1, arg2);
        break;
    default:
        return -1;
    }
    return 0;
}

int main()
{   

    *((unsigned long long *)&vmcode[111 * 8]) = 0x8A654A0A66C30000ULL;
    *((unsigned long long *)&vmcode[112 * 8]) = 0xFF72DF6E424D6238ULL;
    *((unsigned long long *)&vmcode[113 * 8]) = 0xE203C81E6F2B8E09ULL;
    *((unsigned long long *)&vmcode[114 * 8]) = 0x57016E79FD073B53ULL;
    *((unsigned long long *)&vmcode[115 * 8]) = 0x52524F4363A861A8ULL;

    strcpy((char *)&vmcode[116 * 8], "ECT! Here is your flag:\nINCORRECT!KEY: /flag");
    unsigned long long qword_53A8 = 0x67616C66; 
    vmcode[121 * 8 + 5] = (qword_53A8 >> 40) & 0xFF; 
    *((unsigned short *)&vmcode[121 * 8 + 6]) = (qword_53A8 >> 48) & 0xFFFF; 

    // printf("vmcode contents:\n");
    // for (int i = 111; i <= 121; i++) {
    //     printf("vmcode[%d]: 0x%llx\n", i, *((unsigned long long *)&vmcode[i * 8]));
    // }
    for (int c = 0 ; c< 28 ; c++){
            printf("%#hhx ", vmcode[923-c]);
    }
    unsigned char operation, arg1, arg2;
  
    // while(registers.i < 228){
    //     arg2 = vmcode[3*registers.i];
    //     operation = vmcode[3*registers.i + 1];
    //     arg1 = vmcode[3*registers.i + 2];
    //     registers.i =  registers.i + 1;
    //     interpret_instruction(operation, arg1, arg2);    
    // }
    return 0;
}


//0x20, 0xb9, 0x20, 0x4, 0x20, 0x8, 0x4, 0x10, 0x0, 0x4, 0x40, 0x0, 0x4, 0x20, 0x0, 0x4, 0x0, 0x20, 0x4, 0x0, 0x40, 0x4, 0x0, 0x10, 0x20, 0x96, 0x8, 0x20, 0x1, 0x40, 0x2, 0x4, 0x40, 0x20, 0x43, 0x1, 0x4, 0x1, 0x0, 0x20, 0x4f, 0x1, 0x4, 0x1, 0x0, 0x20, 0x52, 0x1, 0x4, 0x1, 0x0, 0x20, 0x52, 0x1, 0x4, 0x1, 0x0, 0x20, 0x45, 0x1, 0x4, 0x1, 0x0, 0x20, 0x43, 0x1, 0x4, 0x1, 0x0, 0x20, 0x54, 0x1, 0x4, 0x1, 0x0, 0x20, 0x21, 0x1, 0x4, 0x1, 0x0, 0x20, 0x20, 0x1, 0x4, 0x1, 0x0, 0x20, 0x59, 0x1, 0x4, 0x1, 0x0, 0x20, 0x6f, 0x1, 0x4, 0x1, 0x0, 0x20, 0x75, 0x1, 0x4, 0x1, 0x0, 0x20, 0x72, 0x1, 0x4, 0x1, 0x0, 0x20, 0x20, 0x1, 0x4, 0x1, 0x0, 0x20, 0x66, 0x1, 0x4, 0x1, 0x0, 0x20, 0x6c, 0x1, 0x4, 0x1, 0x0, 0x20, 0x61, 0x1, 0x4, 0x1, 0x0, 0x20, 0x67, 0x1, 0x4, 0x1, 0x0, 0x20, 0x3a, 0x1, 0x4, 0x1, 0x0, 0x20, 0xa, 0x1, 0x4, 0x1, 0x0, 0x20, 0x14, 0x20, 0x20, 0x1, 0x10, 0x8, 0x1, 0x1, 0x20, 0x2f, 0x1, 0x20, 0x80, 0x20, 0x1, 0x1, 0x20, 0x20, 0x66, 0x1, 0x20, 0x81, 0x20, 0x1, 0x1, 0x20, 0x20, 0x6c, 0x1, 0x20, 0x82, 0x20, 0x1, 0x1, 0x20, 0x20, 0x61, 0x1, 0x20, 0x83, 0x20, 0x1, 0x1, 0x20, 0x20, 0x67, 0x1, 0x20, 0x84, 0x20, 0x1, 0x1, 0x20, 0x20, 0x0, 0x1, 0x20, 0x85, 0x20, 0x1, 0x1, 0x20, 0x20, 0x80, 0x10, 0x20, 0x0, 0x40, 0x8, 0x1, 0x2, 0x20, 0x0, 0x40, 0x2, 0x4, 0x40, 0x20, 0xff, 0x20, 0x20, 0x0, 0x10, 0x2, 0x1, 0x10, 0x8, 0x1, 0x10, 0x20, 0x0, 0x40, 0x2, 0x4, 0x40, 0x20, 0x0, 0x20, 0x2, 0x1, 0x20, 0x20, 0x1, 0x10, 0x8, 0x1, 0x1, 0x20, 0x0, 0x10, 0x8, 0x0, 0x20, 0x4, 0x10, 0x0, 0x4, 0x40, 0x0, 0x4, 0x20, 0x0, 0x20, 0x1, 0x40, 0x2, 0x4, 0x40, 0x20, 0x4b, 0x1, 0x4, 0x1, 0x0, 0x20, 0x45, 0x1, 0x4, 0x1, 0x0, 0x20, 0x59, 0x1, 0x4, 0x1, 0x0, 0x20, 0x3a, 0x1, 0x4, 0x1, 0x0, 0x20, 0x20, 0x1, 0x4, 0x1, 0x0, 0x20, 0x5, 0x20, 0x20, 0x1, 0x10, 0x8, 0x1, 0x1, 0x4, 0x0, 0x20, 0x4, 0x0, 0x40, 0x4, 0x0, 0x10, 0x4, 0x10, 0x0, 0x4, 0x40, 0x0, 0x4, 0x20, 0x0, 0x20, 0x30, 0x40, 0x20, 0xb, 0x20, 0x20, 0x0, 0x10, 0x8, 0x1, 0x10, 0x4, 0x0, 0x20, 0x4, 0x0, 0x40, 0x4, 0x0, 0x10, 0x20, 0x2, 0x8, 0x20, 0x1, 0x40, 0x2, 0x4, 0x40, 0x20, 0x49, 0x1, 0x4, 0x1, 0x0, 0x20, 0x4e, 0x1, 0x4, 0x1, 0x0, 0x20, 0x43, 0x1, 0x4, 0x1, 0x0, 0x20, 0x4f, 0x1, 0x4, 0x1, 0x0, 0x20, 0x52, 0x1, 0x4, 0x1, 0x0, 0x20, 0x52, 0x1, 0x4, 0x1, 0x0, 0x20, 0x45, 0x1, 0x4, 0x1, 0x0, 0x20, 0x43, 0x1, 0x4, 0x1, 0x0, 0x20, 0x54, 0x1, 0x4, 0x1, 0x0, 0x20, 0x21, 0x1, 0x4, 0x1, 0x0, 0x20, 0xa, 0x1, 0x4, 0x1, 0x0, 0x20, 0xb, 0x20, 0x20, 0x1, 0x10, 0x8, 0x1, 0x1, 0x20, 0x1, 0x10, 0x8, 0x0, 0x20, 0x20, 0x30, 0x10, 0x20, 0x75, 0x40, 0x20, 0x9, 0x20, 0x20, 0x2, 0x1, 0x2, 0x8, 0x1, 0x4, 0x1, 0x0, 0x20, 0xa3, 0x8, 0x20, 0x0, 0x20, 0x10, 0x20, 0x1, 0x20, 0x9, 0x1, 0x80, 0x1, 0x4, 0x20, 0x79, 0x1, 0x80, 0x1, 0x3, 0x2, 0x20, 0x10, 0x2, 0x20, 0x40, 0x20, 0xff, 0x1, 0x2, 0x1, 0x10, 0x2, 0x1, 0x40, 0x4, 0x10, 0x0, 0x4, 0x40, 0x0, 0x40, 0x10, 0x10, 0x40, 0x40, 0x40, 0x10, 0x40, 0x10, 0x4, 0x0, 0x40, 0x4, 0x0, 0x10, 0x20, 0xb7, 0x1, 0x80, 0x1, 0x8, 0x20, 0xff, 0x1, 0x2, 0x1, 0x20, 0x20, 0x0, 0x1, 0x10, 0x1, 0x20, 0x20, 0xa5, 0x1, 0x80, 0x1, 0x8, 0x4, 0x20, 0x1, 0x4, 0x0, 0x8, 0x20, 0x8d, 0x1, 0x20, 0x73, 0x20, 0x1, 0x1, 0x20, 0x20, 0x23, 0x1, 0x20, 0x74, 0x20, 0x1, 0x1, 0x20, 0x20, 0x16, 0x1, 0x20, 0x75, 0x20, 0x1, 0x1, 0x20, 0x20, 0xd2, 0x1, 0x20, 0x76, 0x20, 0x1, 0x1, 0x20, 0x20, 0x77, 0x1, 0x20, 0x77, 0x20, 0x1, 0x1, 0x20, 0x20, 0x4f, 0x1, 0x20, 0x78, 0x20, 0x1, 0x1, 0x20, 0x20, 0x6a, 0x1, 0x20, 0x79, 0x20, 0x1, 0x1, 0x20, 0x20, 0x73, 0x1, 0x20, 0x7a, 0x20, 0x1, 0x1, 0x20, 0x20, 0x93, 0x1, 0x20, 0x7b, 0x20, 0x1, 0x1, 0x20, 0x20, 0x7f, 0x1, 0x20, 0x7c, 0x20, 0x1, 0x1, 0x20, 0x20, 0x79, 0x1, 0x20, 0x7d, 0x20, 0x1, 0x1, 0x20, 0x20, 0x59, 0x8, 0x0, 0x0, 0x0